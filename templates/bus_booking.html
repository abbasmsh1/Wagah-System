{% extends "base.html" %}

{% block content %}
<h1>Bus Booking</h1>
<form id="searchForm" method="get" action="/bus-booking/">
    <label for="its">Search by ITS:</label>
    <input type="number" id="its" name="its" required>
    <button type="submit">Search</button>
</form>

{% if person %}
<h2>Master Table Details</h2>
<table>
    <tr>
        <th>ITS</th>
        <th>Name</th>
        <th>Mobile</th>
    </tr>
    <tr>
        <td>{{ person.ITS }}</td>
        <td>{{ person.first_name }}</td>
        <td>{{ person.phone }}</td>
    </tr>
</table>

<h2>Book a Bus</h2>
<form id="bookingForm" action="/book-bus/" method="post">
    <input type="hidden" name="its" value="{{ person.ITS }}">
    <label for="type">Type:</label>
    <select id="type" name="type" required>
        <option value="business">Business</option>
        <option value="executive">Executive</option>
    </select><br>
    <label for="bus_number">Bus Number:</label>
    <select id="bus_number" name="bus_number" required>
        {% for bus in buses %}
            {% if bus.no_of_seats > 0 %}
                <option value="{{ bus.bus_number }}">{{ bus.bus_number }}</option>
            {% endif %}
        {% endfor %}
    </select><br>
    <label for="no_of_seats">Number of Seats:</label>
    <input type="number" id="no_of_seats" name="no_of_seats" value="1" readonly><br>
    <label for="seats_left">Seats Left:</label>
    <span id="seats_left"></span><br>
    <button type="submit">Book Bus</button>
</form>

{% if error %}
<p style="color:red;">{{ error }}</p>
{% endif %}
{% if message %}
<p style="color:green;">{{ message }}</p>
{% endif %}

{% endif %}

{% if form_error %}
<p style="color:red;">{{ form_error }}</p>
{% endif %}

<script>
document.addEventListener("DOMContentLoaded", function() {
    // Function to fetch and display seats left for the selected bus
    document.getElementById("bus_number").addEventListener("change", function() {
        const busNumber = this.value;
        fetch(`/get-bus-info/?bus_number=${busNumber}`)
            .then(response => response.json())
            .then(data => {
                document.getElementById("seats_left").textContent = data.seatsLeft;
            })
            .catch(error => console.error("Error fetching bus info:", error));
    });

    // Fetch and display bus info based on the default selected bus number
    document.getElementById("bus_number").dispatchEvent(new Event("change"));
});
</script>
{% endblock %}
